<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
  <style type="text/css">
      html {
          height: 100%
      }

      body {
          height: 450px;
          margin: 0;
          padding: 0
      }

      #js-map-canvas {
          height: 100%
      }
  </style>
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?client=gme-greatschoolsinc&amp;libraries=geometry&amp;sensor=false&amp;signature=qeUgzsyTsk0gcv93MnxnJ_0SGTw="></script>

  <script type="text/javascript">

      var optionalLat = optionalLat || 37.807778;
      var optionalLon = optionalLon || -122.265149;
      var centerPoint = new google.maps.LatLng(optionalLat, optionalLon);
      var bounds = new google.maps.LatLngBounds();
      var infoWindow;

      function initialize() {
          var myOptions = {
              center: centerPoint,
              mapTypeId: google.maps.MapTypeId.ROADMAP,
              disableDefaultUI: true,
              mapTypeControl: true,
              mapTypeControlOptions: {
                  mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE]
              },
              zoomControl: true,
              zoomControlOptions: {
                  style: google.maps.ZoomControlStyle.DEFAULT
              },
              streetViewControl: true,
              panControl: true,
              infoWindow: infoWindow,

              zoom: 12
          };
          var map = new google.maps.Map(document.getElementById("js-map-canvas"),
                  myOptions);

          var position;

          <% schools.each do |school|%>
              position = new google.maps.LatLng(<%= school.latitude%>, <%= school.longitude%>);
              var markerOptions = new google.maps.Marker({
                  position: position,
                  map: map
    //              title: 'hello'
              });

              var imageUrl;
              var imageUrlPublic = '/assets/icons/140106-24x24_ratings.png';
              var imageUrlPrivate = '/assets/icons/120905-ratingsx24-private-RYG.png';

              var schoolRating = <%=(school.respond_to?(:overall_gs_rating) ? school.overall_gs_rating : 11 )%>; //NR is 11

    //              need to add school level code
              if ('<%= school.type%>' != 'private') {

                  var pixelOffset = 240;// default to public NR

    //need to handle case of no rating
                  if (schoolRating != "" && parseInt(schoolRating) > 0) {
                      pixelOffset = (schoolRating - 1) * 24;
                  }
                  imageUrl = imageUrlPublic;

              } else {
                  pixelOffset = 240;// default to private NR
                  if (schoolRating != "" && parseInt(schoolRating) > 0) {
                      pixelOffset = (schoolRating - 1) * 24;
                  }
                  imageUrl = imageUrlPrivate;
              }

              markerOptions.icon = new google.maps.MarkerImage(
                      imageUrl, // url
                      new google.maps.Size(24, 24), // size
                      new google.maps.Point(pixelOffset, 0), // origin
                      new google.maps.Point(12, 12) // anchor
              );


              var infoWindow = new google.maps.InfoWindow({
                content: ""
              });

              bounds.extend(position);

              var marker = new google.maps.Marker(markerOptions);

              bounds.extend(position);

              google.maps.event.addListener(marker, 'click', (function (marker) {
                  return function () {
                      var markerContent = '<%= school.name%><div><%= school.street%></div><div>GS rating: <%=(school.respond_to?(:overall_gs_rating) ? school.overall_gs_rating : 'NR' )%> Community rating: <%= school.community_rating%></div>';
                      infoWindow.setContent(markerContent);
                      infoWindow.open(map, marker);
                  }
              })(marker));

              if (!bounds.isEmpty()) {
                  map.setCenter(bounds.getCenter(), map.fitBounds(bounds));
              }
          <% end %>

      }
      google.maps.event.addDomListener(window, 'load', initialize);

  </script>
</head>
<body>

<div id="js-map-canvas"/>
</body>
