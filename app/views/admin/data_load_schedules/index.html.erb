<%= render 'nav/topnav' %>
<div class="row limit_width_1200">
  <div class="row pbl">
    <div class="container" style="padding:10px;">
      <h2>Data loading schedule</h2>
      <p>TODO:</p>
      <ul>
        <li>We should still be able to see loads that should have been completed but were skipped in some not annoying way.</li>
      </ul>
      <h5>Filter by</h5>

      <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
          Type
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <% @load_types.each do |filter| %>
              <li>
                <%= link_to filter.to_s.titleize,
                            admin_data_load_schedules_path(params.merge({type: filter})) %>
              </li>
          <% end %>
        </ul>
      </div>

      <div class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
          Status
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <% @status_filters.each do |filter| %>
              <li>
                <%= link_to filter.to_s.titleize,
                            admin_data_load_schedules_path(params.merge({filter_by: filter})) %>
              </li>
          <% end %>
        </ul>
      </div>

      <div class="pull-right">
        <div class="btn-group">
          <%= link_to 'List view',
                        admin_data_load_schedules_path(params.merge({view_type: :list})),
                        class: 'btn btn-default' %>
          <%= link_to 'Calendar view',
                        admin_data_load_schedules_path(params.merge({view_type: :calendar})),
                        class: 'btn btn-default' %>
        </div>
      </div>

      <br>
      <br>
      <strong>Sort by:</strong>&nbsp;
      <% @sorts.each do |sort_param| %>
      <%= link_to sort_param.to_s.gsub('_',' ').titleize, admin_data_load_schedules_path(params.merge({sort_by: sort_param})) %>&nbsp;&nbsp;
      <% end %>



      <% # For viewing ease, only show one month back and two in the future%>
      <% current_month = Date::MONTHNAMES.index(Time.now.strftime("%B")) %>
      <% months = Date::MONTHNAMES[(current_month-1)..(current_month+2)] %>

      <% if @view_type == 'calendar' %>
      <table class="table table-striped">
        <thead>
        <tr>
          <td><h5>State</h5></td>
          <% months.each do |month| %>
              <% next if month.nil? %>
              <% [1, 15].each do |release| %>
                  <td><h5><%= "#{month} #{release}" %></h5></td>
              <% end %>
          <% end %>
        </tr>
        </thead>
        <% @loads.each do |load| %>
            <% next unless load.live_by and load.live_by.year <= Time.now.year %>
            <% next unless months.include? load.live_by_month.gsub(/ \w+/,'') %>
            <tr>
              <td>
                <% if load.state =~ /all/i %>
                    <%= load.state %>
                <% else %>
                    <%= load.state %>
                <% end %>
              </td>
              <% months.each do |month| %>
                  <% next if month.nil? %>
                  <% [1, 15].each do |release| %>
                      <% if load.live_by_month == "#{month} #{release}" %>
                          <td>
                            <% if load.state =~ /all/i %>
                                <%= load.description + ' ' + load.load_type %>
                            <% else %>
                                <%= load.load_type %>
                            <% end %>
                            <% if load.live_by.year != Time.now.year %>
                                <%= '(' + load.live_by.year.to_s + ')' %>
                            <% end %>
                          </td>
                      <% else %>
                          <td></td>
                      <% end %>
                  <% end %>
              <% end %>
        <% end %>
        </tr>
      </table>
      <% end %>
      <% if @view_type == 'list' %>
      <table class="table table-striped">
        <thead>
        <tr>
          <td>State</td>
          <td>Description</td>
          <td>Type</td>
          <td>Year on site</td>
          <td>Year to load</td>
          <td>Released</td>
          <td>Live by</td>
          <td>Complete</td>
        </tr>
        </thead>
        <tbody>
        <% @loads.each do |load|%>
            <tr>
              <td><%= load.state %></td>
              <td><%= load.description %></td>
              <td><%= load.load_type %></td>
              <td><%= load.year_on_site %></td>
              <td><%= load.year_to_load %></td>
              <td><%= load.released %></td>
              <td><%= load.live_by %></td>
              <td><%= load.complete ? 'Yes' : 'No' %></td>
              <td><%= link_to 'edit', edit_admin_data_load_schedule_path(load, params)%></td>
            </tr>
        <% end %>
        </tbody>
      </table>
      <% end %>
      <%= link_to 'Add one', new_admin_data_load_schedule_path %><br>
    </div>
  </div>
</div>
