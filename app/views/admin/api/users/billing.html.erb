<% content_for :head do %>
  <script src="https://js.stripe.com/v3/"></script>
<% end %>

<input id="cardholder-name" type="text">
<!-- placeholder for Elements -->
<form id="setup-form">
  <div class="col-xs-12" id="card-element"></div>
  <button id="card-button" data-secret="<%= @intent.client_secret %>">
    Save Card
  </button>
  <div id='card-errors' role="alert"></div>
</form>

<script>
  const stripe = Stripe('pk_test_51H0VJqC0DFRCPjlNW8vkvuYb3M3cH0YuxdkFUcM8OytmtolVlgs2Y95DFKh9vkcbAyuge8bk25oyYRBmIZs6qsan00JxM8dNrG');
  const elements = stripe.elements();
  const cardElement = elements.create('card');
  cardElement.mount('#card-element');

  window.onload = function () {
    const cardholderName = document.getElementById('cardholder-name');
    const cardButton = document.getElementById('card-button');
    const clientSecret = cardButton.dataset.secret;

    cardButton.addEventListener('click', function (ev) {

      stripe.confirmCardSetup(
        clientSecret,
        {
          payment_method: {
            card: cardElement,
            billing_details: {
              name: cardholderName.value,
            },
          },
        }
      ).then(function (result) {
        if (result.error) {
          // Display error.message in your UI.
          const errorElement = document.getElementById('card-errors');
          errorElement.textContent = result.error.message;
        } else {
          console.log("Card successfully added. Redirecting to confirmation");
          // send card id back to controller to be rendered into confirmation page
        }
      });
    });
  }
</script>