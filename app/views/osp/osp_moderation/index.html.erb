<div style="width: 90%; margin: auto; padding: 30px 0;">

  <%= render partial: 'osp/osp_moderation/reviewer_actions_buttons' %>

  <table class="table table-striped" style="margin: auto;">
    <thead>
    <tr style="background: #5B5B5B; color: white; font-size: 14px;">
      <th></th>
      <th>School</th>
      <th>Email</th>
      <th>Id</th>
      <th>Name</th>
      <th>Job title</th>
      <th>Web url</th>
      <th>Note</th>
    </tr>
    </thead>
    <tbody>
      <% @osp_memberships.each do |_osp| %>
        <% osp = OspModerationDecorator.decorate(_osp)%>
        <% highlight = osp.highlight_color%>
        <tr>
        <% if highlight %>
          <td style="background: <%=highlight%>"><input class="osp-member" type="checkbox" id="<%=osp.id%>"></td>
        <% else %>
          <td><input class="osp-member" type="checkbox" id="<%=osp.id%>"></td>
        <%end%>
          <td>
            <strong><%= link_to(osp.school.name, root_path + "#{States.state_path(osp.state.downcase)}/city/#{osp.school_id}-school-name", target: :_blank) if osp.school%></strong><br>
           <%= osp.state%>-<%= osp.school_id%>
          </td>
          <td><%= osp.user.email%></td>
          <td><%= osp.user.id%></td>
          <td><%= osp.user.first_name.capitalize%> <%= osp.user.last_name.capitalize%></td>
          <td><%= osp.job_title%></td>
          <td><%= osp.web_url%></td>
          <td>
            <textarea class="osp-notes"><%= osp.note %></textarea>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <%= render(partial: 'osp/osp_moderation/pagination_links') unless @pagination_link_count <= 1 %>

</div>

<script type="text/javascript" charset="utf-8">

  const collectOspMembershipIds = function(){
//    If box is checked, create tuple in format [id, notes]
    let ospMemberArray = [];
    $('.osp-member').each(function() {
      var $this = $(this);
      if ($this.is(':checked')) {
        ospMemberArray.push([$this.attr('id'), $this.closest('tr').find('textarea.osp-notes').val()]);
      }
    });
    return ospMemberArray;
  };


  $('.submit-osp-membership').find('button').on('click', function(){
    var status = $(this).attr('data-id');
    var memberArray = collectOspMembershipIds();
//    Don't fire ajax call unless user has selected osp-members to update
    if (memberArray.length > 0) {
      $.ajax({
        method: 'POST',
        url: '/admin/osp-moderation',
        data: {member_array: memberArray, status: status},
        success: function () {
          location.reload();
        },
        error: function(){
          alert('A problem occurred while trying to process your request. Try refreshing the page and submitting again. Contact support if you continue to receive this message.')
        }
      });
    } else {
      alert('Please check at least one box before clicking the buttons!');
    }
  })
</script>